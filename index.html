<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV & Cover Letter Generator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --background-color: #f8fafc;
            --card-color: #ffffff;
            --text-color: #1e293b;
            --muted-color: #64748b;
            --success-color: #16a34a;
            --error-color: #dc2626;
        }

        body {
            font-family: 'Inter', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-section {
            display: none;
            background: var(--card-color);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            position: relative;
            padding: 1rem 0;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: #e2e8f0;
            z-index: 0;
            transform: translateY(-50%);
            border-radius: 2px;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 0;
            height: 4px;
            background: var(--primary-color);
            z-index: 1;
            transform: translateY(-50%);
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            padding: 0.5rem;
            position: relative;
            z-index: 2;
            cursor: pointer;
        }

        .progress-step:hover .step-number {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .progress-step.active .step-number {
            background: var(--primary-color);
            color: white;
            transform: scale(1.2);
            box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.2);
        }

        .progress-step.completed .step-number {
            background: var(--success-color);
            color: white;
        }

        .step-number {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--muted-color);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .progress-step.active .step-label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .progress-step.completed .step-label {
            color: var(--success-color);
        }

        textarea, input, button {
            width: 100%;
            padding: 0.75rem;
            margin: 0.75rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .nav-btn:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        .template-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .template-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            background: var(--card-color);
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .template-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }

        .template-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .template-card h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .template-card p {
            color: var(--muted-color);
            font-size: 0.875rem;
        }

        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .output {
            background: var(--card-color);
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            min-height: 400px;
            overflow-y: auto;
        }

        .output h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-section {
            background: var(--card-color);
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-top: 1rem;
            display: none;
        }

        .analysis-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .analysis-item {
            margin-bottom: 0.75rem;
        }

        .analysis-item h4 {
            color: var(--text-color);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .analysis-item p {
            color: var(--muted-color);
            font-size: 0.875rem;
        }

        .interview-prep-section {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background-color);
            overflow-y: auto;
            z-index: 1000;
            padding: 2rem;
        }

        .interview-prep-section.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .prep-category {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--background-color);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .prep-category:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .interview-section-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .question-item {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--card-color);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .question-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .answer-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--muted-color);
        }

        .tips-section {
            background: rgba(37, 99, 235, 0.05);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .tips-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .editable {
            border: 2px dashed var(--primary-color);
            padding: 1rem;
            background-color: rgba(37, 99, 235, 0.05);
        }

        .editable:focus {
            outline: none;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .email-section {
            margin-top: 2rem;
            padding: 2rem;
            background: var(--card-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .email-output {
            background: var(--card-color);
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: 'Inter', sans-serif;
        }

        .email-header {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .email-field {
            margin-bottom: 0.5rem;
            color: var(--muted-color);
        }

        .email-body {
            white-space: pre-line;
            line-height: 1.6;
        }

        .floating-interview-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.25);
            cursor: pointer;
            z-index: 999;
            border: none;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1.5rem;
        }

        .floating-interview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
        }

        .floating-interview-btn.active {
            background: var(--secondary-color);
            transform: scale(0.95);
        }

        .ai-notification {
            position: fixed;
            bottom: 5rem;
            right: 2rem;
            background: var(--card-color);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 250px;
            z-index: 998;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .ai-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .ai-notification-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ai-notification-icon {
            background: rgba(37, 99, 235, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .ai-notification-text {
            flex: 1;
        }

        .ai-notification-title {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .ai-notification-desc {
            color: var(--muted-color);
            font-size: 0.85rem;
        }

        .pulse-ring {
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            opacity: 0;
            transform: scale(1.1);
        }

        @keyframes pulseRing {
            0% { transform: scale(1.1); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .floating-interview-btn.pulse .pulse-ring {
            animation: pulseRing 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .chat-message {
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.3s forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message, .user-message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }

        .bot-message {
            background: var(--primary-color);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }

        .user-message {
            background: var(--card-color);
            border: 1px solid var(--primary-color);
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-input {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--card-color);
            border-top: 1px solid #e2e8f0;
            position: sticky;
            bottom: 0;
        }

        .chat-input input {
            flex-grow: 1;
            margin: 0;
        }

        .chat-input button {
            width: auto;
            margin: 0;
        }

        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .option-button {
            background: var(--card-color);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-button:hover {
            background: var(--primary-color);
            color: white;
        }

        .role-select {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .role-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background: var(--card-color);
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .role-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .bot-message .feedback {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.3);
            font-size: 0.9em;
            opacity: 0.9;
        }

        .typing-indicator {
            padding: 0.5rem;
            display: inline-block;
            font-style: italic;
            color: var(--muted-color);
        }

        /* New styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            max-width: 900px;
            margin: 0 auto;
            background: #f8fafc;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-header {
            padding: 1.5rem;
            background: var(--primary-color);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .chat-header p {
            margin: 0.5rem 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #ffffff;
        }

        .chat-message {
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.3s forwards;
        }

        .bot-message, .user-message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 1.5rem;
            line-height: 1.5;
            position: relative;
        }

        .bot-message {
            background: var(--primary-color);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }

        .user-message {
            background: #f1f5f9;
            color: var(--text-color);
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-input-container {
            padding: 1.25rem;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .chat-input {
            display: flex;
            gap: 0.75rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 12px;
        }

        .chat-input input {
            flex-grow: 1;
            margin: 0;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            font-size: 1rem;
        }

        .chat-input input:focus {
            outline: none;
            box-shadow: none;
        }

        .chat-input button {
            padding: 0.75rem 1.5rem;
            margin: 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .option-button {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            opacity: 0.7;
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Add these new styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-container {
            background: var(--card-color);
            padding: 2rem;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .auth-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            color: var(--muted-color);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: -2px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }

        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--card-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .logout-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            padding: 0;
            margin: 0;
            border-radius: 50%;
            background: var(--card-color);
            border: 2px solid var(--primary-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 9999;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .logout-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .logout-btn svg {
            width: 18px;
            height: 18px;
            color: var(--primary-color);
            transition: color 0.3s ease;
        }

        .logout-btn:hover svg {
            color: white;
        }

        .logout-btn .tooltip {
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--text-color);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .logout-btn:hover .tooltip {
            opacity: 1;
            visibility: visible;
            margin-right: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js" integrity="sha512-ml/QKfG3+Yes6TwOzQb7aCNtJF4PUyha6R3w8pSTo/VJSywl7ZreYvvtUso7fKevpsI+pYVVwnu82YO0q3V6eg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Add this global function before any other scripts
        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            document.querySelector(`.auth-tab:${tab === 'login' ? 'first-child' : 'last-child'}`).classList.add('active');
            document.getElementById(`${tab}Form`).classList.add('active');
        }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAO4CdS6VAgvCPfqujrJTM386DD-cFnPo8",
            authDomain: "cvtailor-firebase-ai-app.firebaseapp.com",
            projectId: "cvtailor-firebase-ai-app",
            storageBucket: "cvtailor-firebase-ai-app.firebasestorage.app",
            messagingSenderId: "893222305408",
            appId: "1:893222305408:web:e854a2e31a860a4542f065"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User is signed in:', user.email);
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'flex'; // Changed from 'block' to 'flex'
            } else {
                console.log('User is signed out');
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        });

        // Make auth functions globally available
        window.handleLogin = async (event) => {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Login successful:', userCredential.user.email);
                errorElement.style.display = 'none';
            } catch (error) {
                console.error('Login error:', error);
                errorElement.style.display = 'block';
                errorElement.textContent = error.message;
            }
        };

        window.handleSignup = async (event) => {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const errorElement = document.getElementById('signupError');
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log('Signup successful:', userCredential.user.email);
                errorElement.style.display = 'none';
            } catch (error) {
                console.error('Signup error:', error);
                errorElement.style.display = 'block';
                errorElement.textContent = error.message;
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                console.log('Logout successful');
                window.location.reload(); // Add this line to refresh the page
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out: ' + error.message);
            }
        };

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('logoutBtn').addEventListener('click', window.handleLogout);
        });
    </script>
    <script>
        // ...existing code...
        
        // Add these constants at the top with your other constants
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 1000; // 1 second
        const BACKUP_API_KEY = 'YOUR_BACKUP_API_KEY'; // Consider adding a backup key

        // Replace the GEMINI_API_KEY constant with DEEPSEEK_API_KEY
        const DEEPSEEK_API_KEY = 'sk-63b9dfae9f8a4f3fb49a3c94e664c46a';

        // Update the retryableApiCall function
        async function retryableApiCall(payload, retries = MAX_RETRIES) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                {
                                    role: "user",
                                    content: payload.contents[0].parts[0].text
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 2000
                        })
                    });

                    // ...rest of error handling remains the same...
                    if (response.status === 429) {
                        const waitTime = RETRY_DELAY * attempt;
                        console.log(`Rate limited, waiting ${waitTime}ms before retry ${attempt}`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || response.statusText);
                    }

                    const data = await response.json();
                    // Convert DeepSeek response format to match Gemini format
                    return {
                        candidates: [{
                            content: {
                                parts: [{
                                    text: data.choices[0].message.content
                                }]
                            }
                        }]
                    };
                } catch (error) {
                    if (attempt === retries) throw error;
                    console.log(`Attempt ${attempt} failed, retrying...`);
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                }
            }
        }

        // Update the generateDocument function to use the new retry logic
        async function generateDocument() {
            // ...existing validation code...

            try {
                // Generate CV with retry logic
                const cvPayload = {
                    contents: [{
                        parts: [{
                            text: `You are a professional CV writer. Generate a professional CV with ONLY these exact sections in order:
                                // ...existing prompt...`
                        }]
                    }]
                };

                const cvResponse = await retryableApiCall(cvPayload);

                // Generate Cover Letter with retry logic
                const coverLetterPayload = {
                    contents: [{
                        parts: [{
                            text: `You are a professional cover letter writer. Generate a formal business cover letter following these guidelines:
                                // ...existing prompt...`
                        }]
                    }]
                };

                const coverLetterResponse = await retryableApiCall(coverLetterPayload);

                // Process responses
                const cleanCvContent = (cvResponse.candidates[0].content.parts[0].text || 'No CV generated')
                    .replace(/^'''html'''\s*/i, '')
                    .trim();
                    
                const cleanCoverLetterContent = (coverLetterResponse.candidates[0].content.parts[0].text || 'No cover letter generated')
                    .replace(/^'''html'''\s*/i, '')
                    .trim();

                // Update UI
                document.getElementById('cvOutput').innerHTML = cleanCvContent;
                document.getElementById('coverLetterOutput').innerHTML = cleanCoverLetterContent;
                
                // ...rest of existing code...

            } catch (error) {
                console.error('Document generation error:', error);
                document.getElementById('cvOutput').innerHTML = `
                    <div class="error-message">
                        Error generating CV: ${error.message}. 
                        <button onclick="regenerateDocument()" class="nav-btn">Try Again</button>
                    </div>`;
                document.getElementById('coverLetterOutput').innerHTML = `
                    <div class="error-message">
                        Error generating cover letter: ${error.message}. 
                        <button onclick="regenerateDocument()" class="nav-btn">Try Again</button>
                    </div>`;
            }
        }

        // Add a regeneration function
        async function regenerateDocument() {
            document.getElementById('cvOutput').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            document.getElementById('coverLetterOutput').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            await generateDocument();
        }

        // ...rest of existing code...
    </script>
</head>
<body>
    <div class="auth-header">
        <h1>CV & Cover Letter Generator</h1>
    </div>
    <button id="logoutBtn" class="logout-btn" onclick="handleLogout()" title="Logout">
        <span class="tooltip">Logout</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
    </button>

    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Upload CV</div>
        </div>
        <div class="progress-step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Job Details</div>
        </div>
        <div class="progress-step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Template</div>
        </div>
        <div class="progress-step" data-step="4">
            <div class="step-number">4</div>
            <div class="step-label">Preview</div>
        </div>
    </div>

    <!-- CV Upload Section -->
    <div id="cvUploadSection" class="form-section active" data-step="1">
        <h2>Upload Your CV</h2>
        <input type="file" id="cvUpload" accept="application/pdf">
        <div class="nav-buttons">
            <button class="nav-btn" id="nextToJobDesc" onclick="showSection('jobDescSection')">Next</button>
        </div>
    </div>

    <!-- Job Description Section -->
    <div id="jobDescSection" class="form-section">
        <h2>Job Description</h2>
        <textarea id="jobDescription" placeholder="Paste the job description here..." rows="10"></textarea>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="showSection('cvUploadSection')">Back</button>
            <button class="nav-btn" id="nextToTemplate" onclick="showSection('templateSection')">Next</button>
        </div>
    </div>

    <!-- Template Selection Section -->
    <div id="templateSection" class="form-section">
        <h2>Select Template</h2>
        <div class="template-options">
            <div class="template-card" onclick="selectTemplate(1)">
                <div class="template-icon">📄</div>
                <h3>Professional</h3>
                <p>Clean and modern design</p>
            </div>
            <div class="template-card" onclick="selectTemplate(2)">
                <div class="template-icon">🎨</div>
                <h3>Creative</h3>
                <p>Modern with creative elements</p>
            </div>
            <div class="template-card" onclick="selectTemplate(3)">
                <div class="template-icon">🏛️</div>
                <h3>Classic</h3>
                <p>Traditional and formal style</p>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="showSection('jobDescSection')">Back</button>
            <button class="nav-btn" id="generateBtn" onclick="showSection('previewSection'); generateDocument()" disabled>Generate</button>
        </div>
    </div>

    <!-- Preview Section -->
    <div id="previewSection" class="form-section">
        <h2>Generated Documents</h2>
        <div class="preview-section">
            <div>
                <h3>CV</h3>
                <div id="cvOutput" class="output">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="nav-btn" onclick="regenerateCv()">Regenerate CV</button>
                    <button class="nav-btn" onclick="downloadDocument('cvOutput', 'cv.html')">Download CV</button>
                    <button class="nav-btn" onclick="toggleEdit('cvOutput')">Edit CV</button>
                </div>
                <div id="cvAnalysis" class="analysis-section" style="display: none;">
                    <h3>CV Strength Analysis</h3>
                    <div id="cvAnalysisContent"></div>
                </div>
            </div>
            <div>
                <h3>Cover Letter</h3>
                <div id="coverLetterOutput" class="output">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="nav-btn" onclick="regenerateCoverLetter()">Regenerate Cover Letter</button>
                    <button class="nav-btn" onclick="downloadDocument('coverLetterOutput', 'cover_letter.html')">Download Cover Letter</button>
                    <button class="nav-btn" onclick="toggleEdit('coverLetterOutput')">Edit Cover Letter</button>
                </div>
                <div id="coverLetterAnalysis" class="analysis-section" style="display: none;">
                    <h3>Cover Letter Strength Analysis</h3>
                    <div id="coverLetterAnalysisContent"></div>
                </div>
            </div>
        </div>
        
        <!-- Add this section inside the preview-section div, after the interview-prep-section -->
        <div class="email-section">
            <h2 class="interview-section-title">Outreach Email</h2>
            <div id="emailOutput" class="email-output">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <div class="button-group">
                <button class="nav-btn" onclick="regenerateEmail()">Regenerate Email</button>
                <button class="nav-btn" onclick="copyEmail()">Copy Email</button>
                <button class="nav-btn" onclick="toggleEdit('emailOutput')">Edit Email</button>
            </div>
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn" onclick="showSection('templateSection')">Back</button>
        </div>
    </div>

    <!-- Move the interview prep section outside the preview section and to the bottom of the body -->
    <div class="interview-prep-section">
        <button class="close-interview-btn" onclick="toggleInterviewPrep()">Close</button>
        <div class="chat-container">
            <div class="chat-header">
                <h2>Interview Coach</h2>
                <p>Practice your interview with AI-powered feedback</p>
            </div>
            <div class="role-select">
                <button class="role-btn active" onclick="setInterviewMode('practice')">Practice Interview</button>
                <button class="role-btn" onclick="setInterviewMode('feedback')">Get Feedback</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message">
                    <div class="bot-message">
                        Welcome! I'll be your interview coach today. I've reviewed your CV and the job description, and I'm ready to help you prepare for your interview. Would you like to:
                        <div class="options-container">
                            <button class="option-button" onclick="startInterview('full')">Start Full Interview</button>
                            <button class="option-button" onclick="selectTopic('technical')">Practice Technical Questions</button>
                            <button class="option-button" onclick="selectTopic('behavioral')">Practice Behavioral Questions</button>
                            <button class="option-button" onclick="selectTopic('situational')">Practice Situational Questions</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-input">
                    <input type="text" id="userInput" placeholder="Type your response here..." onkeypress="handleKeyPress(event)">
                    <button class="nav-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add the floating button -->
    <button class="floating-interview-btn" onclick="toggleInterviewPrep()" title="AI Interview Coach">
        🤖
        <div class="pulse-ring"></div>
    </button>

    <div class="ai-notification" id="aiNotification">
        <div class="ai-notification-content">
            <div class="ai-notification-icon">🎯</div>
            <div class="ai-notification-text">
                <div class="ai-notification-title">AI Interview Coach Ready!</div>
                <div class="ai-notification-desc">Click the icon to practice your interview skills</div>
            </div>
        </div>
    </div>

    <script>
        function downloadDocument(elementId, filename) {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById(elementId);
            
            // If the document is in edit mode, save it first
            if (element.contentEditable === 'true') {
                toggleEdit(elementId);
            }

            // Configure html2canvas with optimized settings
            const canvasOptions = {
                scale: 1.5, // Reduced from 2 to 1.5 for better file size
                useCORS: true,
                logging: false,
                allowTaint: true,
                backgroundColor: '#ffffff'
            };

            html2canvas(element, canvasOptions).then(canvas => {
                // Optimize canvas
                const optimizedCanvas = document.createElement('canvas');
                const ctx = optimizedCanvas.getContext('2d');
                
                // Set smaller dimensions while maintaining aspect ratio
                const maxWidth = 1240; // Reduced maximum width
                const scaleFactor = maxWidth / canvas.width;
                optimizedCanvas.width = maxWidth;
                optimizedCanvas.height = canvas.height * scaleFactor;
                
                // Draw with smoothing
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(canvas, 0, 0, optimizedCanvas.width, optimizedCanvas.height);

                // Get optimized image data with reduced quality
                const imgData = optimizedCanvas.toDataURL('image/jpeg', 0.75); // Using JPEG with 75% quality

                // Create PDF with optimized settings
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                const ratio = Math.min(pdfWidth / imgProps.width, pdfHeight / imgProps.height) * 0.95; // Slightly reduced ratio

                const width = imgProps.width * ratio;
                const height = imgProps.height * ratio;
                const x = (pdfWidth - width) / 2;
                const y = (pdfHeight - height) / 2;

                // Add image with compression
                pdf.addImage({
                    imageData: imgData,
                    x: x,
                    y: y,
                    width: width,
                    height: height,
                    compression: 'JPEG',
                    quality: 0.75
                });

                // Save with optimization
                const pdfOptions = {
                    compress: true,
                    precision: 4,
                    optimization: {
                        compress: true,
                        compressLevel: 9
                    }
                };

                pdf.save(filename.replace('.html', '.pdf'), pdfOptions);
            }).catch(error => {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            });
        }
    </script>

    <script>
        let cvContent = '';
        let jobDescription = '';
        let selectedTemplate = null;
        let keywords;
        let matchedKeywords;
        let keywordMatchScore;
        let jobDescriptionWords;
        let personalizedWords;
        let personalizationScore;
        let atsCompatibilityScore;
        let currentStep = 1;
        const GEMINI_API_KEY = 'AIzaSyB5GNmttJhM2HXwRTQLhpl9C1SIhCxX04o';

        async function extractTextFromPDF(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function() {
                    try {
                        const typedarray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            
                            fullText += textContent.items.map(item => item.str).join(' ');
                        }
                        resolve(fullText);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function selectTemplate(templateId) {
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.template-card:nth-child(${templateId})`).classList.add('selected');
            selectedTemplate = templateId;
            document.getElementById('generateBtn').disabled = false;
        }

        async function generateDocument() {
            const fileInput = document.getElementById('cvUpload');
            if (!fileInput.files.length) {
                alert('Please upload and analyze your CV first');
                return;
            }
            
            document.getElementById('cvOutput').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            document.getElementById('coverLetterOutput').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

            try {
                const file = fileInput.files[0];
                cvContent = await extractTextFromPDF(file);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('cvOutput').innerHTML = 'Error: ' + error.message;
                return;
            }

            if (!jobDescription) {
                alert('Please enter the job description');
                return;
            }
            if (!selectedTemplate) {
                alert('Please select a template');
                return;
            }
            
            try {
                // Generate CV
                const cvPayload = {
                    contents: [{
                        parts: [{
                            text: `You are a professional CV writer. Generate a professional CV with ONLY these exact sections in order:

1. Header with name and contact information
2. Professional summary
3. Work experience (company, position, dates, and bullet points of achievements)
4. Education
5. Skills
6. Certifications (if any)

Format using HTML tags:
- Use <h2> for section headers
- Use <ul> and <li> for lists
- Use <p> for paragraphs
- Use <strong> for emphasis

STRICT REQUIREMENTS:
- ONLY include the sections listed above in the exact order
- DO NOT add any Additional Information section
- DO NOT include any other sections
- DO NOT include '''html''' markers
- Remove any additional sections from the source CV

Here is my current CV content: ${cvContent}\n\nPlease generate an improved version with proper formatting.`
                        }]
                    }]
                };

                const cvResponse = await retryableApiCall(cvPayload);

                // Generate Cover Letter
                const coverLetterPayload = {
                    contents: [{
                        parts: [{
                            text: `You are a professional cover letter writer. Generate a formal business cover letter following these guidelines:

Format Guidelines:
- Use proper business letter format
- Include date at the top
- Include recipient's address block
- Include proper salutation
- Keep paragraphs concise and professional
- Use proper closing

Content Structure:
1. Opening paragraph: Introduce yourself and state the position you're applying for
2. Body paragraph(s): Highlight relevant skills and experience that match the job requirements
3. Closing paragraph: Express enthusiasm, request an interview, and provide contact information

Format using minimal HTML tags:
- Use <p> for paragraphs
- Use <br> for line breaks between address blocks
- Avoid using headers or other structural tags
- Keep formatting clean and professional

Style Guidelines:
- Keep tone professional but engaging
- Be concise and specific
- Focus on value proposition
- Maintain formal business letter conventions

IMPORTANT: 
- Do NOT include section headings or labels
- Do NOT include '''html''' markers
- Format as a standard business letter
- Keep spacing and structure clean and professional

Here is my CV: ${cvContent}
Here is the job description: ${jobDescription}

Please generate a professionally formatted cover letter that follows traditional business letter conventions.`
                        }]
                    }]
                };

                const coverLetterResponse = await retryableApiCall(coverLetterPayload);

                const cleanCvContent = (cvResponse.candidates[0].content.parts[0].text || 'No CV generated')
                    .replace(/^'''html'''\s*/i, '')
                    .trim();
                    
                const cleanCoverLetterContent = (coverLetterResponse.candidates[0].content.parts[0].text || 'No cover letter generated')
                    .replace(/^'''html'''\s*/i, '')
                    .trim();
                
                document.getElementById('cvOutput').innerHTML = cleanCvContent;
                document.getElementById('coverLetterOutput').innerHTML = cleanCoverLetterContent;
                
                analyzeDocument('cv', cleanCvContent);
                analyzeDocument('coverLetter', cleanCoverLetterContent);
                
                document.getElementById('cvAnalysis').style.display = 'block';
                document.getElementById('coverLetterAnalysis').style.display = 'block';
                
                // Show the floating button after successful generation
                const interviewBtn = document.querySelector('.floating-interview-btn');
                const notification = document.getElementById('aiNotification');
                
                interviewBtn.style.display = 'flex';
                interviewBtn.classList.add('show', 'pulse');
                
                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                    
                    // Hide notification after 3 seconds
                    setTimeout(() => {
                        notification.classList.remove('show');
                        interviewBtn.classList.remove('pulse');
                    }, 3000);
                }, 500);

                await generateInterviewPrep(); // Generate content but keep it hidden
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('cvOutput').innerHTML = 'Error: ' + error.message;
                document.getElementById('coverLetterOutput').innerHTML = 'Error: ' + error.message;
            }
            
            await generateEmail(); // Add this line
        }

        async function analyzeDocument(docType, content) {
            const analysisContentId = docType === 'cv' ? 'cvAnalysisContent' : 'coverLetterAnalysisContent';
            const analysisDiv = document.getElementById(analysisContentId);
            analysisDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{
                            role: "user",
                            content: `You are a professional CV and cover letter analyzer. Provide a detailed strength analysis of the following document, focusing on these aspects:
                            // ...existing prompt...`
                        }],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Analysis failed: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                const analysisText = data.choices[0].message.content || 'Failed to generate analysis';
                const suggestionsMatch = analysisText.match(/<div class="analysis-item">\s*<h4>Suggestions for Improvement<\/h4>\s*<p>(.*?)<\/p>\s*<\/div>/s);
                const suggestions = suggestionsMatch ? suggestionsMatch[1].trim() : 'No suggestions provided';
                analysisDiv.innerHTML = analysisText.replace(/<div class="analysis-item">\s*<h4>Suggestions for Improvement<\/h4>\s*<p>.*?<\/p>\s*<\/div>/s, '');
                
                try {
                    const suggestionResponse = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [{
                                role: "user",
                                content: `You are a professional CV and cover letter analyzer. Based on the following analysis, provide specific suggestions on how to improve the document.
                                Here is the analysis: ${analysisText}\n\nHere is the document: ${content}\n\nHere is the job description: ${jobDescription}\n\nPlease provide the suggestions in a single paragraph.`
                            }],
                            temperature: 0.7,
                            max_tokens: 1000
                        })
                    });

                    if (!suggestionResponse.ok) {
                        const errorData = await suggestionResponse.json();
                        throw new Error(`Suggestion generation failed: ${errorData.error?.message || suggestionResponse.statusText}`);
                    }

                    const suggestionData = await suggestionResponse.json();
                    const suggestionText = suggestionData.choices[0].message.content || 'No suggestions provided';
                    document.getElementById(`${docType}Suggestions`).textContent = suggestionText;
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById(`${docType}Suggestions`).textContent = 'Error generating suggestions';
                }
            } catch (error) {
                console.error('Error:', error);
                analysisDiv.innerHTML = 'Error: ' + error.message;
            }
        }

        async function handleCvUpload() {
            const fileInput = document.getElementById('cvUpload');
            if (!fileInput.files.length) {
                alert('Please select a CV file');
                return;
            }

            const file = fileInput.files[0];
            document.getElementById('cvOutput').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                cvContent = await extractTextFromPDF(file);
                document.getElementById('cvOutput').textContent = 'CV analyzed successfully!';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('cvOutput').innerHTML = 'Error: ' + error.message;
            }
        }

        async function regenerateCv() {
            document.getElementById('cvOutput').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            try {
                // Get suggestions if they exist, otherwise use empty string
                const suggestions = document.getElementById('cvSuggestions') ? 
                    document.getElementById('cvSuggestions').textContent : '';

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a professional CV writer. Generate a professional CV with ONLY these exact sections in order:

1. Header with name and contact information
2. Professional summary
3. Work experience (company, position, dates, and bullet points of achievements)
4. Education
5. Skills
6. Certifications (if any)

Format using HTML tags:
- Use <h2> for section headers
- Use <ul> and <li> for lists
- Use <p> for paragraphs
- Use <strong> for emphasis

STRICT REQUIREMENTS:
- ONLY include the sections listed above in the exact order
- DO NOT add any Additional Information section
- DO NOT include any other sections
- DO NOT include '''html''' markers
- Remove any additional sections from the source CV

Here is my current CV content: ${cvContent}
${suggestions ? '\n\nHere are the suggestions for improvement: ' + suggestions : ''}
\nPlease generate an improved version with proper formatting.`
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`CV regeneration failed: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                const cleanCvContent = (data.candidates[0].content.parts[0].text || 'Failed to regenerate CV')
                    .replace(/^'''html'''\s*/i, '')
                    .trim();
                document.getElementById('cvOutput').innerHTML = cleanCvContent;
                analyzeDocument('cv', cleanCvContent);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('cvOutput').innerHTML = 'Error: ' + error.message;
            }
        }

        async function regenerateCoverLetter() {
            document.getElementById('coverLetterOutput').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            try {
                 const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                         contents: [{
                            parts: [{
                                text: `You are a professional cover letter writer. Generate a formal business cover letter following these guidelines:

Format Guidelines:
- Use proper business letter format
- Include date at the top
- Include recipient's address block
- Include proper salutation
- Keep paragraphs concise and professional
- Use proper closing

Content Structure:
1. Opening paragraph: Introduce yourself and state the position you're applying for
2. Body paragraph(s): Highlight relevant skills and experience that match the job requirements
3. Closing paragraph: Express enthusiasm, request an interview, and provide contact information

Format using minimal HTML tags:
- Use <p> for paragraphs
- Use <br> for line breaks between address blocks
- Avoid using headers or other structural tags
- Keep formatting clean and professional

Style Guidelines:
- Keep tone professional but engaging
- Be concise and specific
- Focus on value proposition
- Maintain formal business letter conventions

IMPORTANT: 
- Do NOT include section headings or labels
- Do NOT include '''html''' markers
- Format as a standard business letter
- Keep spacing and structure clean and professional

Here is my CV: ${cvContent}
Here is the job description: ${jobDescription}

Please generate a professionally formatted cover letter that follows traditional business letter conventions.`
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Cover letter regeneration failed: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                document.getElementById('coverLetterOutput').innerHTML = data.candidates[0].content.parts[0].text || 'Failed to regenerate cover letter';
                const cleanCoverLetterContent = (data.candidates[0].content.parts[0].text || 'No cover letter generated')
                    .replace(/^'''html'''\s*/i, '')
                    .trim();
                analyzeDocument('coverLetter', cleanCoverLetterContent);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('coverLetterOutput').innerHTML = 'Error: ' + error.message;
            }
        }

        async function generateInterviewPrep() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="chat-message">
                    <div class="bot-message">
                        Hello! I'm your AI interview coach. I'll be conducting a mock interview based on the position you're applying for. Ready to begin?
                        <div class="options-container">
                            <button class="option-button" onclick="startInterview('full')">Start Full Interview</button>
                            <button class="option-button" onclick="selectTopic('technical')">Technical Questions</button>
                            <button class="option-button" onclick="selectTopic('behavioral')">Behavioral Questions</button>
                            <button class="option-button" onclick="selectTopic('situational')">Situational Questions</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function regenerateInterviewPrep() {
            await generateInterviewPrep();
        }

        async function generateEmail() {
            const emailOutput = document.getElementById('emailOutput');
            emailOutput.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{
                            role: "user",
                            content: `Generate a professional outreach email based on this job description and CV. The email should:
                            // ...existing prompt...`
                        }],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate email content');
                }

                const data = await response.json();
                emailOutput.innerHTML = data.choices[0].message.content;
            } catch (error) {
                console.error('Error:', error);
                emailOutput.innerHTML = 'Error generating email: ' + error.message;
            }
        }

        async function regenerateEmail() {
            await generateEmail();
        }

        function copyEmail() {
            const emailContent = document.getElementById('emailOutput').innerText;
            navigator.clipboard.writeText(emailContent)
                .then(() => alert('Email copied to clipboard!'))
                .catch(err => console.error('Failed to copy email:', err));
        }

        function toggleEdit(elementId) {
            const element = document.getElementById(elementId);
            const isEditable = element.contentEditable === 'true';
            
            if (isEditable) {
                // Save mode
                element.contentEditable = 'false';
                element.classList.remove('editable');
                // Save the content for analysis
                const content = element.innerHTML;
                if (elementId === 'cvOutput') {
                    analyzeDocument('cv', content);
                } else if (elementId === 'coverLetterOutput') {
                    analyzeDocument('coverLetter', content);
                }
            } else {
                // Edit mode
                element.contentEditable = 'true';
                element.classList.add('editable');
            }

            // Toggle button text
            const button = event.target;
            button.textContent = isEditable ? `Edit ${elementId === 'cvOutput' ? 'CV' : 'Cover Letter'}` : 'Save Changes';
        }

        // Event Listeners
        document.getElementById('cvUpload').addEventListener('change', handleCvUpload);
        document.getElementById('jobDescription').addEventListener('input', (e) => {
            jobDescription = e.target.value;
        });

        // Initialize first section
        updateProgressBar();

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show the selected section
            document.getElementById(sectionId).classList.add('active');

            // Update progress bar
            currentStep = parseInt(document.getElementById(sectionId).dataset.step);
            updateProgressBar();
        }

        function updateProgressBar() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                step.classList.toggle('active', index + 1 === currentStep);
                step.classList.toggle('completed', index + 1 < currentStep);
            });
        }

        function toggleInterviewPrep() {
            const section = document.querySelector('.interview-prep-section');
            const button = document.querySelector('.floating-interview-btn');
            
            section.classList.toggle('active');
            button.classList.toggle('active');
            
            if (section.classList.contains('active')) {
                button.style.transform = 'scale(0.95)';
            } else {
                button.style.transform = '';
            }
            
            document.body.style.overflow = section.classList.contains('active') ? 'hidden' : '';
        }

        function selectTopic(topic) {
            const messages = {
                technical: "Let's practice technical questions. Here's your first question:",
                behavioral: "Let's work on behavioral questions using the STAR method. Here's your first question:",
                situational: "Let's discuss some situational scenarios. Here's your first case:",
                'talking-points': "Here are the key points you should emphasize in your interview:"
            };
            
            addMessage(messages[topic], 'bot');
            generateQuestionForTopic(topic);
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `<div class="${sender}-message">${text}</div>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function generateQuestionForTopic(topic) {
            const prompt = `Based on this CV: ${cvContent} and job description: ${jobDescription}, generate a ${topic} interview question and its ideal answer.`;
            
            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) throw new Error('Failed to generate question');
                
                const data = await response.json();
                const content = data.candidates[0].content.parts[0].text;
                addMessage(content, 'bot');
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, I had trouble generating a question. Please try again.', 'bot');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `As an interview coach, respond to this interview practice answer. Context - CV: ${cvContent}, Job Description: ${jobDescription}, User's answer: ${message}`
                            }]
                        }]
                    })
                });

                if (!response.ok) throw new Error('Failed to get response');
                
                const data = await response.json();
                const content = data.candidates[0].content.parts[0].text;
                addMessage(content, 'bot');
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, I had trouble responding. Please try again.', 'bot');
            }
        }

        let interviewMode = 'practice';
        let currentQuestion = '';
        let questionHistory = [];
        let interviewContext = {
            role: '',
            stage: 'intro',
            score: 0,
            feedback: []
        };

        function setInterviewMode(mode) {
            interviewMode = mode;
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(mode));
            });
            addMessage(`Switched to ${mode} mode. ${mode === 'practice' ? 'I will act as the interviewer.' : 'I will provide detailed feedback on your answers.'}`, 'bot');
        }

        async function startInterview(type) {
            interviewContext = {
                role: type,
                stage: 'intro',
                score: 0,
                feedback: []
            };

            const prompt = `You are a professional interviewer conducting a ${type} interview. Based on the job description: ${jobDescription}
                           and the candidate's CV: ${cvContent}, introduce yourself naturally and ask your first question.
                           Important guidelines:
                           - Be warm and professional
                           - Speak in a natural, conversational tone
                           - Avoid using asterisks or special formatting
                           - Ask one clear question at a time
                           - Keep responses concise and engaging
                           - Match the formality level of a real interview`;

            addTypingIndicator();
            try {
                const response = await getAIResponse(prompt);
                removeTypingIndicator();
                addMessage(response, 'bot');
                currentQuestion = response;
            } catch (error) {
                removeTypingIndicator();
                addMessage('I apologize, but I seem to be having trouble starting the interview. Shall we try again?', 'bot');
            }
        }

        function addTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                Interviewer is typing
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) typingDiv.remove();
        }

        async function getAIResponse(prompt) {
            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + GEMINI_API_KEY, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                })
            });

            if (!response.ok) throw new Error('Failed to get response');
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Modify the existing generateInterviewPrep function
        async function generateInterviewPrep() {
            questionHistory = [];
            interviewContext = {
                role: '',
                stage: 'intro',
                score: 0,
                feedback: []
            };
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="chat-message">
                    <div class="bot-message">
                        Hello! I'm your AI interview coach. I'll be conducting a mock interview based on the position you're applying for. Ready to begin?
                        <div class="options-container">
                            <button class="option-button" onclick="startInterview('full')">Start Full Interview</button>
                            <button class="option-button" onclick="selectTopic('technical')">Technical Questions</button>
                            <button class="option-button" onclick="selectTopic('behavioral')">Behavioral Questions</button>
                            <button class="option-button" onclick="selectTopic('situational')">Situational Questions</button>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
    <script type="module">
        import { signUp, login, logout, initializeAuth } from './firebaseAuth.js';

        // Authentication state management
        initializeAuth((user) => {
            if (user) {
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
            } else {
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        });

        // Authentication functions
        window.handleLogin = async (event) => {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            
            try {
                await login(email, password);
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            } catch (error) {
                errorElement.style.display = 'block';
                errorElement.textContent = error.message;
            }
        };

        window.handleSignup = async (event) => {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const errorElement = document.getElementById('signupError');
            
            try {
                await signUp(email, password);
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            } catch (error) {
                errorElement.style.display = 'block';
                errorElement.textContent = error.message;
            }
        };

        window.handleLogout = async () => {
            try {
                await logout();
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            document.querySelector(`.auth-tab:${tab === 'login' ? 'first-child' : 'last-child'}`).classList.add('active');
            document.getElementById(`${tab}Form`).classList.add('active');
        };

        // Add logout button event listener
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    </script>
    <!-- Add the auth overlay HTML if it's missing -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchTab('login')">Login</div>
                <div class="auth-tab" onclick="switchTab('signup')">Sign Up</div>
            </div>
            
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="nav-btn">Login</button>
                <p id="loginError" class="error-message"></p>
            </form>
            
            <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                <input type="email" id="signupEmail" placeholder="Email" required>
                <input type="password" id="signupPassword" placeholder="Password" required minlength="6">
                <button type="submit" class="nav-btn">Sign Up</button>
                <p id="signupError" class="error-message"></p>
            </form>
        </div>
    </div>


